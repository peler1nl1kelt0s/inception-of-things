CLUSTER_NAME := iot-cluster
HOST_PORT := 8888
NODE_PORT := 30080
KUBE_NAMESPACE_ARGOCD := argocd
KUBE_NAMESPACE_DEV := dev
KUBE_NAMESPACE_GITLAB := gitlab

GREEN=\033[0;32m
YELLOW=\033[0;33m
NC=\033[0m

.PHONY: launch all install up clean argocd-install argocd-password argocd-ui app-deploy help

launch: all
	@echo -e "\n${GREEN}[SUCCESS] Kurulum tamamlandÄ±. Son adÄ±mlara geÃ§iliyor...${NC}"
	@$(MAKE) argocd-password
	@$(MAKE) argocd-ui

help:
	@echo -e "${GREEN}KullanÄ±labilir komutlar:${NC}"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  ${YELLOW}%-20s${NC} %s\n", $$1, $$2}'

all: app-deploy

install:
	@echo -e "\n${GREEN}[INFO] Gerekli araÃ§lar kuruluyor...${NC}"
	@chmod +x scripts/install_tools.sh
	@./scripts/install_tools.sh
	@echo -e "\n${YELLOW}[WARN] Docker yetkileri iÃ§in yeni bir terminal aÃ§Ä±n veya 'newgrp docker' komutunu Ã§alÄ±ÅŸtÄ±rÄ±n.${NC}"

up:
	@echo -e "\n${GREEN}[INFO] ğŸš€ K3d kÃ¼mesi (${CLUSTER_NAME}) oluÅŸturuluyor...${NC}"
	@k3d cluster create ${CLUSTER_NAME} -p "${HOST_PORT}:${NODE_PORT}@agent:0" --agents 1
	@echo -e "${GREEN}[SUCCESS] KÃ¼me baÅŸarÄ±yla oluÅŸturuldu.${NC}"

clean:
	@echo -e "\n${YELLOW}[INFO] ğŸ§¹ K3d kÃ¼mesi (${CLUSTER_NAME}) siliniyor...${NC}"
	@k3d cluster delete ${CLUSTER_NAME}
	@echo -e "${GREEN}[SUCCESS] KÃ¼me baÅŸarÄ±yla silindi.${NC}"

argocd-install: up
	@echo -e "\n${GREEN}[INFO] Gerekli namespace'ler oluÅŸturuluyor: ${KUBE_NAMESPACE_ARGOCD}, ${KUBE_NAMESPACE_DEV}${NC}"
	@kubectl create namespace ${KUBE_NAMESPACE_ARGOCD} >/dev/null 2>&1 || echo "Namespace ${KUBE_NAMESPACE_ARGOCD} zaten mevcut."
	@kubectl create namespace ${KUBE_NAMESPACE_DEV} >/dev/null 2>&1 || echo "Namespace ${KUBE_NAMESPACE_DEV} zaten mevcut."
	@kubectl create namespace ${KUBE_NAMESPACE_GITLAB} >/dev/null 2>&1 || echo "Namespace ${KUBE_NAMESPACE_GITLAB} zaten mevcut."
	@echo -e "\n${GREEN}[INFO] Argo CD kuruluyor...${NC}"
	@kubectl apply -n ${KUBE_NAMESPACE_ARGOCD} -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
	@echo -e "${GREEN}[SUCCESS] Argo CD kurulumu iÃ§in kaynaklar uygulandÄ±. Pod'larÄ±n hazÄ±r olmasÄ± biraz zaman alabilir.${NC}"
	@echo -e "${YELLOW}[INFO] Argo CD sunucusunun baÅŸlamasÄ± bekleniyor... (Bu iÅŸlem 1-2 dakika sÃ¼rebilir)${NC}"
	@kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=argocd-server -n ${KUBE_NAMESPACE_ARGOCD} --timeout=120s

argocd-password:
	@echo -e "\n${GREEN}===============================================================${NC}"
	@echo -e "${GREEN}[INFO] ğŸ”‘ Argo CD Admin Åifresi:${NC}"
	@kubectl -n ${KUBE_NAMESPACE_ARGOCD} get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
	@echo

argocd-ui:
	@echo -e "\n${GREEN}[INFO] ğŸŒ Argo CD arayÃ¼zÃ¼ iÃ§in port yÃ¶nlendirme baÅŸlatÄ±lÄ±yor...${NC}"
	@echo -e "TarayÄ±cÄ±nÄ±zdan ${YELLOW}https://localhost:8080${NC} adresine gidin."
	@echo -e "KullanÄ±cÄ± adÄ±: ${YELLOW}admin${NC}"
	@echo -e "Bu terminali aÃ§Ä±k bÄ±raktÄ±ÄŸÄ±nÄ±z sÃ¼rece arayÃ¼ze eriÅŸebilirsiniz."
	@kubectl port-forward svc/argocd-server -n ${KUBE_NAMESPACE_ARGOCD} 8080:443

app-deploy: argocd-install
	@echo -e "\n${GREEN}[INFO] Uygulama Argo CD'ye tanÄ±tÄ±lÄ±yor...${NC}"
	@kubectl apply -f applications/application.yaml
	@echo -e "${GREEN}[SUCCESS] Uygulama baÅŸarÄ±yla daÄŸÄ±tÄ±ldÄ±. Senkronizasyon iÃ§in Argo CD arayÃ¼zÃ¼nÃ¼ kontrol edin.${NC}"